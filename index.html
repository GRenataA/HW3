<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Driven Decision System ¬∑ Sentiment to Action</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            max-width: 700px;
            margin: 2rem auto;
            padding: 0 1rem;
            background: #f9fafb;
            color: #111827;
        }
        h1 {
            font-size: 1.8rem;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 0.5rem;
        }
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin: 1.5rem 0;
        }
        label {
            display: block;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.25rem;
            color: #374151;
        }
        input, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button, .action-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        button:hover, .action-button:hover {
            background: #2563eb;
        }
        .status {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f3f4f6;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: #1f2937;
            word-break: break-word;
        }
        #action-result {
            padding: 1.25rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }
        .action-button {
            margin-top: 0.75rem;
            background: white;
            color: #111827;
            border: 1px solid #d1d5db;
        }
        .action-button:hover {
            background: #f3f4f6;
        }
        .sentiment-badge {
            display: inline-block;
            padding: 0.25rem 1rem;
            border-radius: 9999px;
            background: #e5e7eb;
            font-size: 0.85rem;
            font-weight: 600;
            color: #1f2937;
            margin-top: 0.5rem;
        }
        .hidden {
            display: none;
        }
        hr {
            border: 1px solid #e5e7eb;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Automatic Firefighter ¬∑ CRM</h1>
    <p>Connect your AI models and let the system act automatically.</p>

    <!-- ========== CONFIGURATION CARD ========== -->
    <div class="card">
        <h3>üîß 1. Configuration</h3>
        
        <label>ü§ó Hugging Face API Token</label>
        <input type="text" id="hfToken" placeholder="hf_xxxxxxxxxxxxxxxxxxxx" value="">
        <button id="saveTokenBtn">Save Token</button>
        
        <label>üìä Google Sheets Web App URL</label>
        <input type="url" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec">
        <button id="saveUrlBtn">Save Web App URL</button>
        
        <div id="configStatus" class="status">‚öôÔ∏è Ready ‚Äì paste your keys and save them.</div>
    </div>

    <!-- ========== ANALYSIS CARD ========== -->
    <div class="card">
        <h3>‚úçÔ∏è 2. Customer Review</h3>
        <label for="reviewText">What did the customer say?</label>
        <textarea id="reviewText" placeholder="e.g. The product arrived broken, very disappointed..."></textarea>
        <button id="analyzeBtn">üîç Analyze & Take Action</button>
        
        <!-- Spinner / loading (hidden by default) -->
        <div id="loading" class="hidden" style="margin-top:1rem; color:#6b7280;">‚è≥ Analyzing sentiment...</div>
    </div>

    <!-- ========== DECISION OUTPUT ========== -->
    <div id="action-result" style="background:#f3f4f6; color:#111827;">
        üí¨ Awaiting a review...
    </div>

    <!-- Optional raw sentiment display -->
    <div id="sentimentMeta" style="font-size:0.9rem; color:#4b5563; margin-top:0.5rem;"></div>

    <!-- ========== LOG STATUS ========== -->
    <div id="logStatus" class="status" style="background:#e0f2fe;">üìã Log ready</div>

    <hr>
    <p style="font-size:0.8rem; color:#6b7280; text-align:center;">
        AI‚ÄëDriven Decision System ¬∑ Assignment: From Insight to Action
    </p>

    <script>
        // -------------------------------------------------------------
        //  CONSTANTS & CONFIG
        // -------------------------------------------------------------
        const HF_API_URL = "https://router.huggingface.co/hf-inference/models/cardiffnlp/twitter-roberta-base-sentiment-latest";
        const LS_TOKEN_KEY = "hf_token";
        const LS_URL_KEY = "gas_url";
        const LS_UID_KEY = "uid";

        // -------------------------------------------------------------
        //  UTILITIES: localStorage, user ID
        // -------------------------------------------------------------
        function getUserId() {
            let uid = localStorage.getItem(LS_UID_KEY);
            if (!uid) {
                uid = crypto?.randomUUID?.() || Math.random().toString(36).slice(2);
                localStorage.setItem(LS_UID_KEY, uid);
            }
            return uid;
        }

        // Load saved token into input field
        function loadSavedToken() {
            const saved = localStorage.getItem(LS_TOKEN_KEY);
            if (saved) {
                document.getElementById('hfToken').value = saved;
            }
        }
        function saveToken() {
            const token = document.getElementById('hfToken').value.trim();
            if (!token) {
                document.getElementById('configStatus').textContent = '‚ùå Please enter a token.';
                return;
            }
            localStorage.setItem(LS_TOKEN_KEY, token);
            document.getElementById('configStatus').textContent = '‚úÖ Hugging Face token saved.';
        }

        // GAS URL ‚Äì same logic as the provided logger
        function getGasUrl() {
            const input = document.getElementById('gasUrl');
            const entered = (input?.value || '').trim();
            if (entered) return entered;
            const saved = (localStorage.getItem(LS_URL_KEY) || '').trim();
            if (input && saved) input.value = saved;
            return saved;
        }
        function saveGasUrl() {
            const status = document.getElementById('configStatus');
            const url = (document.getElementById('gasUrl')?.value || '').trim();
            if (!url) {
                status.textContent = '‚ùå Paste your Apps Script Web App URL (ends with /exec).';
                return;
            }
            try { new URL(url); } catch { status.textContent = '‚ùå Invalid URL format.'; return; }
            localStorage.setItem(LS_URL_KEY, url);
            status.textContent = '‚úÖ Web App URL saved.';
        }

        // -------------------------------------------------------------
        //  BUSINESS LOGIC (determine action)
        //  –¢–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–∫–∂–µ HTML –¥–ª—è –∫–Ω–æ–ø–∫–∏/—Å—Å—ã–ª–∫–∏
        // -------------------------------------------------------------
        function determineBusinessAction(confidence, label) {
            const upperLabel = String(label).toUpperCase().trim();

            let normalizedScore;
            let displayLabel = upperLabel;

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–µ—Ç–∫–∏ –º–æ–¥–µ–ª–∏ cardiffnlp
            if (upperLabel === "LABEL_0") {        // –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π
                displayLabel = "NEGATIVE";
                normalizedScore = 1.0 - confidence;
            } else if (upperLabel === "LABEL_2") { // –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π
                displayLabel = "POSITIVE";
                normalizedScore = confidence;
            } else if (upperLabel === "LABEL_1") { // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π
                displayLabel = "NEUTRAL";
                normalizedScore = 0.5;
            } else {
                normalizedScore = 0.5; // –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –º–µ—Ç–∫–∞ ‚Üí –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
            }

            // –ü–æ—Ä–æ–≥–∏ –∏–∑ –º–∞—Ç—Ä–∏—Ü—ã –∑–∞–¥–∞–Ω–∏—è
            if (normalizedScore <= 0.4) {
                return {
                    actionCode: "OFFER_COUPON",
                    uiMessage: "üö® We are truly sorry.",
                    uiColor: "#ef4444",
                    buttonHtml: `<button class="action-button" onclick="alert('50% discount coupon: SAVE50')">üéüÔ∏è Get 50% off coupon</button>`,
                    displayLabel: displayLabel
                };
            } else if (normalizedScore < 0.7) {
                return {
                    actionCode: "REQUEST_FEEDBACK",
                    uiMessage: "üìù Help us improve!",
                    uiColor: "#6b7280",
                    buttonHtml: `<a href="#" class="action-button" onclick="alert('Opening survey...'); return false;">üìã Take detailed survey</a>`,
                    displayLabel: displayLabel
                };
            } else {
                return {
                    actionCode: "ASK_REFERRAL",
                    uiMessage: "‚≠ê Glad you liked it!",
                    uiColor: "#3b82f6",
                    buttonHtml: `<button class="action-button" onclick="alert('Referral link copied!')">üë• Refer a friend</button>`,
                    displayLabel: displayLabel
                };
            }
        }

        // -------------------------------------------------------------
        //  LOGGING TO GOOGLE SHEETS (CORS‚Äësafe, x-www-form-urlencoded)
        // -------------------------------------------------------------
        async function logSentiment(review, sentimentLabel, confidence, actionCode) {
            const statusEl = document.getElementById('logStatus');
            const url = getGasUrl();
            if (!url) {
                statusEl.textContent = '‚ùå Missing Web App URL. Save it first.';
                return;
            }

            const form = new URLSearchParams();
            form.set('review', review);
            form.set('sentiment', sentimentLabel);
            form.set('confidence', confidence.toString());
            form.set('action_taken', actionCode);
            form.set('userId', getUserId());
            form.set('ts', Date.now().toString());

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    body: form
                });
                const text = await res.text();
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
                statusEl.textContent = '‚úÖ Logged to Google Sheets';
                statusEl.style.background = '#dcfce7';
            } catch (err) {
                statusEl.textContent = `‚ùå Log failed: ${err.message}`;
                statusEl.style.background = '#fee2e2';
                console.error(err);
            }
        }

        // -------------------------------------------------------------
        //  MAIN ANALYSIS: Hugging Face ‚Üí decision ‚Üí UI ‚Üí log
        // -------------------------------------------------------------
        async function analyzeAndAct() {
            const review = document.getElementById('reviewText').value.trim();
            if (!review) {
                alert('Please enter a review.');
                return;
            }

            const token = localStorage.getItem(LS_TOKEN_KEY);
            if (!token) {
                document.getElementById('configStatus').textContent = '‚ùå No Hugging Face token saved.';
                return;
            }

            const loadingEl = document.getElementById('loading');
            const actionDiv = document.getElementById('action-result');
            const sentimentMeta = document.getElementById('sentimentMeta');
            loadingEl.classList.remove('hidden');
            actionDiv.style.background = '#f3f4f6';
            actionDiv.innerHTML = '‚è≥ Analyzing...';
            sentimentMeta.innerHTML = '';

            try {
                const hfResponse = await fetch(HF_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ inputs: review })
                });

                if (!hfResponse.ok) {
                    const errText = await hfResponse.text();
                    throw new Error(`Hugging Face error (${hfResponse.status}): ${errText}`);
                }

                const result = await hfResponse.json();
                const prediction = Array.isArray(result) ? result[0] : result;
                let label, confidence;

                if (Array.isArray(prediction)) {
                    const sorted = prediction.sort((a,b) => b.score - a.score);
                    label = sorted[0].label;
                    confidence = sorted[0].score;
                } else {
                    label = prediction.label;
                    confidence = prediction.score;
                }

                const decision = determineBusinessAction(confidence, label);

                // –û–±–Ω–æ–≤–ª—è–µ–º UI: —Ü–≤–µ—Ç + —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞/—Å—Å—ã–ª–∫–∞
                actionDiv.style.background = decision.uiColor;
                actionDiv.style.color = '#ffffff';
                actionDiv.innerHTML = `
                    <div style="margin-bottom: 0.5rem;">${decision.uiMessage}</div>
                    ${decision.buttonHtml}
                `;

                sentimentMeta.innerHTML = `
                    <span class="sentiment-badge">üß† ${label} (${(confidence*100).toFixed(1)}% confidence)</span>
                    <span style="margin-left:0.75rem;">‚ö° Action: <strong>${decision.actionCode}</strong></span>
                `;

                await logSentiment(review, label, confidence, decision.actionCode);

            } catch (error) {
                actionDiv.style.background = '#f3f4f6';
                actionDiv.style.color = '#111827';
                actionDiv.innerHTML = '‚ùå Analysis failed. Check token / network.';
                sentimentMeta.textContent = `Error: ${error.message}`;
                console.error(error);
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // -------------------------------------------------------------
        //  EVENT LISTENERS & INIT
        // -------------------------------------------------------------
        window.onload = function() {
            loadSavedToken();
            const savedUrl = localStorage.getItem(LS_URL_KEY);
            if (savedUrl) {
                document.getElementById('gasUrl').value = savedUrl;
                document.getElementById('configStatus').textContent = 'üìé Loaded saved Web App URL.';
            }

            document.getElementById('saveTokenBtn').addEventListener('click', saveToken);
            document.getElementById('saveUrlBtn').addEventListener('click', saveGasUrl);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeAndAct);
            document.getElementById('reviewText').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) analyzeAndAct();
            });
        };
    </script>
</body>
</html>
